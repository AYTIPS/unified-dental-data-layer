from fastapi import Depends, APIRouter, status, HTTPException, Request
from sqlalchemy.orm import Session
from core.database import get_db
from  core.schemas import cliniccreate
from auth.oauth2 import get_current_user
from core.models import Users, RegisteredClinics
from  auth.security import encrypt_secret
import logging
from sqlalchemy.exc import SQLAlchemyError
from core.schemas import clinicout

log = logging.getLogger(__name__)


router = APIRouter(
    prefix = "/clinics",
    tags= ["Registsration"]
    )

@router.post("/",  status_code = status.HTTP_201_CREATED, response_model= clinicout)
async def standalone_clinic(payload : cliniccreate,  request: Request, db: Session = Depends(get_db), current_user : Users = Depends(get_current_user)):

    crm_type = payload.crm_type
    clinic_name  = payload.clinic_name
    clinic_number = payload.clinic_number
    clinic_timezone = payload.clinic_timezone
    od_developer_key = payload.od_developer_key
    od_customer_key = payload.od_customer_key
    crm_api_key  = payload.crm_api_key 
    location_id = payload.location_id 
    calendar_id = payload.calendar_id 
    operatory_calendar_map  = payload.operatory_calendar_map

    existing = db.query(RegisteredClinics).filter(RegisteredClinics.owner_id == current_user.id, RegisteredClinics.clinic_name == payload.clinic_name, RegisteredClinics.dso_id.is_(None)). first()
    if existing:
        log.warning("Duplicate clinic creation attempt", extra={
            "user_id" : current_user.id,   
            "clinic_name" : payload.clinic_name,
            "request_id ": request.state.request_id
        },)
        raise HTTPException(status_code = status.HTTP_400_BAD_REQUEST, detail = "You Already have a clinic created already")
    
    clinic = RegisteredClinics(
        crm_type = crm_type,
        clinic_name = clinic_name ,
        clinic_number = clinic_number,
        clinic_timezone = clinic_timezone,
        od_developer_key = encrypt_secret (od_developer_key),
        od_customer_key = encrypt_secret(od_customer_key), 
        crm_api_key = encrypt_secret(crm_api_key),
        location_id = location_id,
        calendar_id = encrypt_secret(calendar_id) ,
        operatory_calendar_map = operatory_calendar_map
        )
    try:
        db.add(clinic)
        db.commit()
        db.refresh(clinic)

        log.info("Account has been successfully created", extra = { 
            "user_id" : current_user.id,
            "clinic_name" : clinic.clinic_name
            })
    except SQLAlchemyError:
        db.rollback()
        log.exception("Database error while creating clinic ", extra= {
            "user_id" : current_user.id,
            "request_id" : request.state.request_id,
            "clinic_name" : payload.clinic_name

            })
        raise HTTPException(status_code = status.HTTP_500_INTERNAL_SERVER_ERROR, detail = "Unable to create clinic at this time")

    return clinic 


